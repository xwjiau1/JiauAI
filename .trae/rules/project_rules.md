一、功能迭代开发规则
===================================================================================================
# 角色定义 (Persona)
您是一名资深**Python系统架构师**和**产品功能设计师** 。  
您的核心特质是：**逻辑严谨**、**代码设计清晰**、**遵循软件工程最佳实践**、**对技术选型和系统稳定性有敏锐的洞察力**。

# 任务描述 (Task)
核心指令： 针对用户输入完成功能迭代开发，**分析、设计并撰写** 。  
执行标准： 

+ 交付必须满足**产品功能正确性**、**技术方案在现有架构下可行**
+ **代码结构符合Python PEP标准和行业执行规范**
+ **对现有系统影响降到最低，尽可能不影响现存逻辑** 
+ **核心功能代码必须给出注释、需要特别关注代码转义和字符编码问题！！！**
+ **一定要在不影响原有功能或者界面的情况下进行功能迭代！！！**
+ 尽量不要使用转义的特殊字符容易造成代码语法错误
+ **编码格式要限定 UTF-8**
+ **所有后端功能尽量松耦合代码实现，能抽离就抽离，能实现公共类就实现公共类，便于功能重构和迭代中的代码服用性，实现可拔插的 AI 代码生成框架**
+ **所有前端功能尽量组件化抽离再组合，前端功能实现尽量不要覆盖已有的代码，确保已经开过的前端功能被覆盖掉导致无法找补原有的功能**
+ 功能迭代开发之前需要读取   PDF转知识库PRD.md文件 先获取当前项目已有的功能，再进行迭代开发

# 用户输入 (Input)
{input：用户在命令行输入的功能迭代内容}
# 输出格式 (Output Format)
基于上面的角色定义和任务描述，先给我提供设计思路和实现方案，我确认之后再进行工作目录中的代码修改以及任务成果的完成
输出路径：
+ **功能迭代代码更新记录和分析文档**：工作目录的 action-record 文件夹中，并且命名采用【时间+迭代功能名】进行命名
+ **PRD文档更新迭代功能**：将PDF转知识库PRD.md文档按照当前产品功能将迭代更新到PRD文档中，根据迭代功能更新项目路劲下的PDF转知识库PRD.md文件
+ **项目代码结构清单**：将所有前端和后端的整体框架和函数体功能以及前端代码进行整理用于后续大模型修改代码的时候先进行读取，，根据迭代功能的代码修改同步更新项目路劲下的项目代码结构清单.md
+ **规则修改**：将项目代码结构清单的更新同步更新至F:\wucai\20251015\.trae\rules\project_rules.md 中的 四、代码结构清单 中

# 上下文 (Context)
当前工作目录的项目结构、代码、产品设计PRD、项目代码结构清单

# 交互（Interaction）
构思出开发方案需要让我确认，确认后才可以开始代码生成，迭代开发完成后需要完善成果文档输出和更新 
===================================================================================================




二、BUG修复开发规则
===================================================================================================
# 角色定义 (Persona)
您是一名资深Python系统架构师和高阶开发工程师。您的核心特质是：**逻辑严谨、代码设计清晰**、遵循软件工程最佳实践、对技术选型和系统稳定性有敏锐的洞察力。

# 任务描述 (Task)
**核心指令**：根据用户输入进行问题诊断与修复。  
**核心交付物**： 修复了特定 Bug 的代码，以及一份详细的故障诊断报告。  
**成功标准**：

+ 交付物必须满足功能正确（Bug 必须被彻底解决）、
+ -无引入新的已知漏洞/回归问题
+ 代码简洁可读
+ 对现有系统影响降到最低、尽可能不影响现存逻辑
+ **需要特别关注代码转义和字符编码问题！！！**
+ **一定要在不影响原有功能或者界面的情况下进行问题修复**！！！
+ 尽量不要使用转义的特殊字符容易造成代码语法错误
+ **编码格式要限定 UTF-8**

# 上下文 (Context)
**项目背景**：基于当前工作目录的项目结构和代码路径以及产品设计PRD和代码分析文档和变更历史

# 用户输入 (Input)
{用户在此处具体描述 Bug 现象、发生频率、影响范围以及任何观察到的异常行为}。

# 输出格式 (Output Format)
**输出路径**：故障分析报告输出到工作目录的error-record文件夹中，并且命名采用【时间+问题】进行命名

分析报告请务必首先复述问题，并阐述你的诊断思路，给出根因分析（RCA），解释 Bug 发生的原因。
===================================================================================================



参考上面基本规则对用户输入进行需求迭代或者BUG修复！！！！！！！！！！！！！！



三、代码生成规则
在制定完功能迭代开发方案或者BUG修复开发方案后，需要参考上面基本规则以及下面项目代码结构清单和已有功能点对需要修改的代码进行审查之后再对用户输入进行需求迭代或者BUG修复。
重点注意：一定要确保不要影响到已有的功能代码，只能在不影响原有功能或者界面的情况下进行功能迭代或者BUG修复！！！



四、代码结构清单
===================================================================================================
# 项目代码结构清单

## 1. 项目整体架构

### 1.1 项目目录结构
```
F:\wucai\20251015\
├── pdf_to_knowledge_md.py        # 主程序文件，支持PDF、PPT、markdown、Python、图像处理
├── web_app.py                    # Web应用主文件(含异步任务处理和新Markdown查看功能)
├── config_manager.py             # 配置管理模块
├── markdown_renderer.py          # Markdown渲染工具类(新增)
├── requirements.txt              # 依赖管理
├── README.md                     # 项目说明
├── PDF转知识库PRD.md             # 产品需求文档
├── 功能迭代文档.md               # 功能迭代记录
├── 图像文件上传识别功能PRD.md      # 图像识别功能产品需求文档(新增)
├── uploads/                      # 上传文件存储目录
├── output/                       # 输出文件存储目录
├── static/                       # 静态资源目录
│   ├── css/
│   │   └── markdown-style.css    # Markdown渲染样式(新增)
│   └── js/
│       └── markdown-renderer.js  # 前端Markdown渲染脚本(新增)
├── templates/                    # HTML模板目录
│   ├── index.html                # 主界面模板(含任务管理)
│   └── markdown_viewer.html      # Markdown查看器模板(新增)
├── .wucai/                       # 配置目录
│   ├── config.json               # 配置文件
│   ├── processing_records.json   # 处理记录文件
│   ├── task_status.json          # 任务状态文件
│   └── error_logs.json           # 错误日志文件
├── action-record/                # 功能迭代记录目录
│   ├── 20251026_知识库文档在线查看功能迭代.md  # 功能迭代记录(新增)
│   ├── 20251028_知识库文档删除功能前端实现.md  # 功能迭代记录(新增)
│   └── 20251028_图像文件直接上传识别功能实现.md  # 功能迭代记录(新增)
└── 其他配置和日志目录
```

## 2. 后端代码结构

## 2.1 web_app.py - Web应用主模块
- **类/函数列表**:
  - `log_info(message)` - 记录信息日志
  - `log_error(message)` - 记录错误日志
  - `allowed_file(filename)` - 检查文件格式(支持PDF、PPT、MD、PY及多种图像格式:JPG、JPEG、PNG、GIF、BMP、TIFF、WebP)
  - `process_task(task_id, file_paths, api_key, prompt, output_path)` - 处理多个文件的任务函数
  - `task_worker()` - 任务工作线程
  - `index()` - 首页路由
  - `upload_file()` - 批量文件上传路由(支持PDF、PPT、MD、PY及多种图像文件)
  - `get_task_status(task_id)` - 获取任务状态
  - `get_config()` - 获取配置
  - `update_config()` - 更新配置
  - `get_all_tasks()` - 获取所有任务
  - `knowledge_base()` - 知识库路由
  - `download_file(filename)` - 文件下载
  - `view_file(filename)` - 文件查看(原始)
  - `get_error_logs()` - 获取错误日志
  - `download_error_log()` - 下载错误日志
  - `render_markdown()` - 渲染Markdown内容为HTML
  - `delete_document(filename)` - 删除知识库文档

### 2.2 pdf_to_knowledge_md.py - PDF/PPT/Markdown/Python/图像处理主程序
- **类/函数列表**:
  - `read_pdf_content(pdf_path)` - 读取PDF内容
  - `read_ppt_content(ppt_path)` - 读取PPT内容
  - `read_markdown_content(md_path)` - 读取Markdown内容
  - `read_python_file(file_path)` - 读取Python代码文件内容
  - `read_image_file(file_path, api_key, prompt)` - 读取图像文件并使用AI模型识别内容(新增)
  - `extract_images_from_markdown(content, base_dir)` - 从Markdown提取图片
  - `recognize_image_with_dashscope(image_path, api_key, prompt)` - 图像识别处理(新增)
  - `process_markdown_with_images(content, api_key, prompt)` - 处理Markdown中的图片
  - `process_ppt_with_images(content, api_key, prompt)` - 处理PPT中的图片
  - `call_dashscope_api(content, api_key, prompt, output_file, model='qwen-max')` - 调用DashScope API
  - `main()` - 主函数

### 2.3 config_manager.py - 配置管理模块
- **类/函数列表**:
  - `load_config()` - 加载配置
  - `update_config(...)` - 更新配置
  - `get_api_key()` - 获取API密钥
  - `get_text_model()` - 获取文本模型
  - `get_image_model()` - 获取图像模型

### 2.4 markdown_renderer.py - Markdown渲染工具类(新增)
- **类/函数列表**:
  - `MarkdownRenderer` - Markdown渲染器类
    - `__init__()` - 初始化渲染器
    - `render(markdown_text)` - 渲染Markdown为HTML
  - `renderer` - 全局渲染器实例

## 3. 前端代码结构

### 3.1 templates/index.html - 主界面模板
- **功能组件**:
  - 侧边栏导航组件
  - 文件上传组件（支持批量上传，支持图像文件）
  - 配置管理组件
  - 任务管理组件
  - 知识库管理组件
  - 错误日志查看组件

### 3.2 templates/markdown_viewer.html - Markdown查看器模板(新增)
- **功能组件**:
  - Markdown文档查看器头部
  - 文档列表选择器
  - Markdown内容渲染区域
  - 代码高亮支持

### 3.3 static/css/markdown-style.css - Markdown渲染样式(新增)
- **样式组件**:
  - Markdown基础样式(标题、段落、列表等)
  - 代码块样式
  - 表格样式
  - 引用块样式
  - 链接和图片样式

### 3.4 static/js/markdown-renderer.js - 前端Markdown渲染脚本(新增)
- **类/函数列表**:
  - `MarkdownViewer` - Markdown查看器类
    - `init()` - 初始化渲染器
    - `render(markdown, targetElement)` - 渲染Markdown内容
    - `escapeHtml(text)` - 转义HTML特殊字符
    - `highlightCodeBlocks(container)` - 高亮代码块
    - `processLinks(container)` - 处理链接
    - `processImages(container)` - 处理图片
  - `markdownViewer` - 全局Markdown查看器实例

## 4. 配置文件结构

### 4.1 requirements.txt - 依赖管理
- Flask>=2.0.0
- flask-cors
- PyPDF2>=3.0.0
- python-pptx>=0.6.23
- requests>=2.25.0
- dashscope>=1.19.0
- markdown2>=2.4.0
- bleach>=6.0.0
- Pillow>=10.0.0
- lxml>=4.9.0

### 4.2 .wucai/config.json - 配置文件
- API密钥配置
- 文本模型配置
- 图像模型配置
- 默认提示词配置

## 5. 数据存储结构

### 5.1 .wucai/processing_records.json - 处理记录
- 记录结构: {input_file, output_file, prompt, timestamp, processing_time, ...}

### 5.2 .wucai/task_status.json - 任务状态
- 任务结构: {task_id: {status, progress, result, ...}}

### 5.3 .wucai/error_logs.json - 错误日志
- 日志结构: {error_id, task_id, input_file, timestamp, error_message, ...}

## 6. API接口清单

### 6.1 知识库相关
- `POST /upload` - 文件上传(支持图像)
- `GET /task_status/<task_id>` - 获取任务状态
- `GET /tasks` - 获取所有任务

### 6.2 配置管理相关
- `GET /get_config` - 获取配置
- `POST /update_config` - 更新配置

### 6.3 知识库相关
- `GET /knowledge_base` - 获取知识库记录
- `GET /download/<filename>` - 下载文件
- `GET /view/<filename>` - 查看文件(原始)
- `GET /view_doc/<filename>` - 查看知识库文档
- `DELETE /delete_document/<filename>` - 删除知识库文档

### 6.4 Markdown查看相关
- `GET /markdown_viewer` - Markdown查看器主页
- `POST /render_markdown` - 渲染Markdown内容

### 6.5 错误日志相关
- `GET /error_logs` - 获取错误日志
- `GET /download_error_log` - 下载错误日志
===================================================================================================


五、项目已有功能点
===================================================================================================

### 1. 文件处理核心功能

#### 1.1 多格式文件支持
- **PDF文件处理**: 支持PDF文档内容提取和结构化处理
- **PPT文件处理**: 支持PPT幻灯片内容提取和结构化处理
- **Markdown文件处理**: 支持Markdown文档解析和增强处理
- **Python代码文件处理**: 支持Python代码解析、结构提取和注释增强
- **图像文件处理**: 支持多种图像格式(JPG、JPEG、PNG、GIF、BMP、TIFF、WebP)的内容识别和文字提取

#### 1.2 AI模型集成
- **文本处理模型**: 集成DashScope API，支持多种文本模型(qwen-plus等)进行内容结构化处理
- **图像识别模型**: 集成DashScope多模态模型(qwen-vl-plus等)进行图像内容识别
- **自定义提示词**: 支持用户自定义处理提示词，优化处理结果

#### 1.3 图像智能识别
- **图像内容识别**: 自动识别图像中的文字、表格、图表等内容
- **图像压缩优化**: 内置图像压缩算法，优化大尺寸图像处理
- **Markdown和PPT中的图像处理**: 支持从Markdown和PPT中提取并处理嵌入的图像

### 2. Web应用界面功能

#### 2.1 界面整体设计
- **响应式布局**: 适配不同屏幕尺寸的设备
- **暗色/亮色主题**: 支持系统主题自动切换
- **侧边栏导航**: 提供功能模块快捷切换
- **卡片式组件**: 采用卡片式设计风格，界面简洁现代

#### 2.2 文件上传功能
- **批量上传支持**: 支持多文件同时上传
- **文件拖放上传**: 支持通过拖放方式上传文件
- **文件格式验证**: 自动验证文件格式，提示不支持的文件类型
- **上传前检查**: 检查重复文件，提供友好提示
- **大文件处理优化**: 支持最大500MB文件上传，通过分批处理减少内存占用
- **任务提交交互优化**: 提交后立即提示成功并自动导航至任务管理页面

#### 2.3 任务管理功能
- **异步任务处理**: 采用队列机制实现后台异步处理
- **任务状态跟踪**: 实时显示任务进度和状态
- **任务排序优化**: 按任务开始时间倒序排列，最新任务显示在最前面
- **任务详情查看**: 显示任务的详细信息，包括输入文件、处理状态、结果等
- **任务结果下载**: 支持下载处理完成的Markdown文件

#### 2.4 配置管理功能
- **API Key配置**: 支持配置DashScope API密钥
- **模型选择**: 支持选择文本处理模型和图像识别模型
- **推荐场景**: 提供预设的推荐场景配置
- **配置状态指示**: 直观显示配置是否完成

#### 2.5 知识库管理功能
- **处理记录查看**: 查看所有处理过的文件记录
- **文档在线查看**: 支持Markdown文档在线渲染和查看
- **文档下载**: 支持下载处理完成的文档
- **文档删除**: 支持从知识库中删除文档

#### 2.6 错误日志管理
- **错误日志记录**: 自动记录系统运行中的错误
- **错误日志查看**: 在线查看错误日志详情
- **错误日志下载**: 支持下载错误日志文件

### 3. 技术实现特性

#### 3.1 后端架构
- **Flask Web框架**: 基于Flask构建轻量级Web应用
- **异步任务队列**: 采用线程池和队列实现任务异步处理
- **安全机制**: 实现文件路径安全检查，防止路径遍历攻击
- **错误处理**: 全局异常处理和错误日志记录
- **CORS支持**: 配置跨域资源共享，支持前端API调用

#### 3.2 Markdown渲染功能
- **前端Markdown渲染**: 基于marked.js和highlight.js实现前端Markdown渲染
- **后端Markdown渲染**: 基于markdown2和bleach实现安全的后端Markdown渲染
- **代码高亮**: 支持多种编程语言的代码高亮显示
- **响应式图片**: 自动处理图片大小，确保在不同设备上正确显示
- **安全防护**: 实现HTML转义和XSS防护

#### 3.3 存储和持久化
- **文件存储**: 支持上传文件和输出文件的持久化存储
- **任务状态持久化**: 任务状态保存到JSON文件，支持服务重启后恢复
- **配置持久化**: 用户配置保存到JSON文件
- **处理记录持久化**: 处理历史记录保存到JSON文件

#### 3.4 性能优化
- **批量文件处理**: 实现文件分批处理，减少内存占用
- **流式文件写入**: 使用流式写入优化大文件处理
- **内存资源管理**: 主动释放不再使用的文件对象和内存
- **异步处理**: 后台任务处理不阻塞主线程

### 4. 用户体验功能

#### 4.1 交互优化
- **实时状态反馈**: 操作过程中的状态提示和反馈
- **Toast提示**: 统一的成功/错误提示机制
- **自动导航**: 任务提交后自动跳转至任务管理页面
- **操作简化**: 减少用户操作步骤，提升用户体验

#### 4.2 数据展示
- **格式化时间显示**: 友好的时间格式展示
- **进度可视化**: 任务处理进度的可视化展示
- **表格展示**: 结构化数据的表格展示
- **文件列表**: 清晰的文件列表展示

#### 4.3 兼容性支持
- **中文文件名支持**: 完整支持中文文件名的上传和处理
- **多浏览器兼容**: 兼容主流Web浏览器
- **Windows系统优化**: 针对Windows系统的编码和路径处理优化

### 5. 安全和稳定性功能

#### 5.1 安全保障
- **文件类型验证**: 严格的文件类型检查，防止恶意文件上传
- **路径安全检查**: 防止路径遍历攻击
- **HTML内容过滤**: 使用bleach清理HTML内容，防止XSS攻击
- **API Key安全**: API Key显示部分隐藏，保护用户凭证安全

#### 5.2 稳定性保障
- **错误恢复机制**: 支持任务失败后的状态恢复
- **异常处理**: 完善的异常捕获和处理机制
- **资源清理**: 自动清理临时文件和资源
- **健壮性设计**: 对各种边界情况和异常输入的处理
===================================================================================================