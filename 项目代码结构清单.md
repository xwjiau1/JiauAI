# 项目代码结构清单

## 1. 项目整体架构

### 1.1 项目目录结构
```
F:\wucai\20251015\
├── pdf_to_knowledge_md.py        # 主程序文件，支持PDF、PPT、markdown处理
├── web_app.py                    # Web应用主文件(含异步任务处理和新Markdown查看功能)
├── config_manager.py             # 配置管理模块
├── markdown_renderer.py          # Markdown渲染工具类(新增)
├── requirements.txt              # 依赖管理
├── README.md                     # 项目说明
├── PDF转知识库PRD.md             # 产品需求文档
├── 功能迭代文档.md               # 功能迭代记录
├── uploads/                      # 上传文件存储目录
├── output/                       # 输出文件存储目录
├── static/                       # 静态资源目录
│   ├── css/
│   │   └── markdown-style.css    # Markdown渲染样式(新增)
│   └── js/
│       └── markdown-renderer.js  # 前端Markdown渲染脚本(新增)
├── templates/                    # HTML模板目录
│   ├── index.html                # 主界面模板(含任务管理)
│   └── markdown_viewer.html      # Markdown查看器模板(新增)
├── .wucai/                       # 配置目录
│   ├── config.json               # 配置文件
│   ├── processing_records.json   # 处理记录文件
│   ├── task_status.json          # 任务状态文件
│   └── error_logs.json           # 错误日志文件
├── action-record/                # 功能迭代记录目录
│   └── 20251026_知识库文档在线查看功能迭代.md  # 功能迭代记录(新增)
└── 其他配置和日志目录
```

## 2. 后端代码结构

### 2.1 web_app.py - Web应用主模块
- **类/函数列表**:
  - `log_info(message)` - 记录信息日志
  - `log_error(message)` - 记录错误日志
  - `exception_handler(f)` - 全局异常处理装饰器
  - `log_error_detail(...)` - 详细错误日志记录
  - `allowed_file(filename)` - 检查文件格式
  - `process_task(...)` - 处理单个任务的函数
  - `task_worker()` - 任务工作线程
  - `index()` - 首页路由
  - `upload_file()` - 文件上传路由
  - `get_task_status(task_id)` - 获取任务状态
  - `get_config()` - 获取配置
  - `update_config()` - 更新配置
  - `get_all_tasks()` - 获取所有任务
  - `knowledge_base()` - 知识库路由
  - `download_file(filename)` - 文件下载
  - `view_file(filename)` - 文件查看(原始)
  - `get_error_logs()` - 获取错误日志
  - `download_error_log()` - 下载错误日志
  - `markdown_viewer()` - Markdown查看器主页(新增)
  - `render_markdown()` - 渲染Markdown内容为HTML(新增)
  - `view_document(filename)` - 查看知识库文档(新增)

### 2.2 pdf_to_knowledge_md.py - PDF/PPT/Markdown处理主程序
- **类/函数列表**:
  - `read_pdf_content(pdf_path)` - 读取PDF内容
  - `read_ppt_content(ppt_path)` - 读取PPT内容
  - `read_markdown_content(md_path)` - 读取Markdown内容
  - `extract_images_from_markdown(content, base_dir)` - 从Markdown提取图片
  - `process_image_with_dashscope(image_path, api_key)` - 图片处理
  - `call_dashscope_api(content, api_key, prompt, output_file, model='qwen-max')` - 调用DashScope API
  - `main()` - 主函数

### 2.3 config_manager.py - 配置管理模块
- **类/函数列表**:
  - `load_config()` - 加载配置
  - `update_config(...)` - 更新配置
  - `get_api_key()` - 获取API密钥
  - `get_text_model()` - 获取文本模型
  - `get_image_model()` - 获取图像模型

### 2.4 markdown_renderer.py - Markdown渲染工具类(新增)
- **类/函数列表**:
  - `MarkdownRenderer` - Markdown渲染器类
    - `__init__()` - 初始化渲染器
    - `render(markdown_text)` - 渲染Markdown为HTML
  - `renderer` - 全局渲染器实例

## 3. 前端代码结构

### 3.1 templates/index.html - 主界面模板
- **功能组件**:
  - 侧边栏导航组件
  - 文件上传组件
  - 配置管理组件
  - 任务管理组件
  - 知识库管理组件
  - 错误日志查看组件

### 3.2 templates/markdown_viewer.html - Markdown查看器模板(新增)
- **功能组件**:
  - Markdown文档查看器头部
  - 文档列表选择器
  - Markdown内容渲染区域
  - 代码高亮支持

### 3.3 static/css/markdown-style.css - Markdown渲染样式(新增)
- **样式组件**:
  - Markdown基础样式(标题、段落、列表等)
  - 代码块样式
  - 表格样式
  - 引用块样式
  - 链接和图片样式

### 3.4 static/js/markdown-renderer.js - 前端Markdown渲染脚本(新增)
- **类/函数列表**:
  - `MarkdownViewer` - Markdown查看器类
    - `init()` - 初始化渲染器
    - `render(markdown, targetElement)` - 渲染Markdown内容
    - `escapeHtml(text)` - 转义HTML特殊字符
    - `highlightCodeBlocks(container)` - 高亮代码块
    - `processLinks(container)` - 处理链接
    - `processImages(container)` - 处理图片
  - `markdownViewer` - 全局Markdown查看器实例

## 4. 配置文件结构

### 4.1 requirements.txt - 依赖管理
- Flask>=2.0.0
- flask-cors
- PyPDF2>=3.0.0
- python-pptx>=0.6.23
- requests>=2.25.0
- dashscope>=1.19.0
- markdown2>=2.4.0 (新增)
- bleach>=6.0.0 (新增)

### 4.2 .wucai/config.json - 配置文件
- API密钥配置
- 文本模型配置
- 图像模型配置
- 默认提示词配置

## 5. 数据存储结构

### 5.1 .wucai/processing_records.json - 处理记录
- 记录结构: {input_file, output_file, prompt, timestamp, processing_time, ...}

### 5.2 .wucai/task_status.json - 任务状态
- 任务结构: {task_id: {status, progress, result, ...}}

### 5.3 .wucai/error_logs.json - 错误日志
- 日志结构: {error_id, task_id, input_file, timestamp, error_message, ...}

## 6. API接口清单

### 6.1 文件处理相关
- `POST /upload` - 文件上传
- `GET /task_status/<task_id>` - 获取任务状态
- `GET /tasks` - 获取所有任务

### 6.2 配置管理相关
- `GET /get_config` - 获取配置
- `POST /update_config` - 更新配置

### 6.3 知识库相关
- `GET /knowledge_base` - 获取知识库记录
- `GET /download/<filename>` - 下载文件
- `GET /view/<filename>` - 查看文件(原始)
- `GET /view_doc/<filename>` - 查看知识库文档(新增)

### 6.4 Markdown查看相关(新增)
- `GET /markdown_viewer` - Markdown查看器主页
- `POST /render_markdown` - 渲染Markdown内容
- `GET /view_doc/<filename>` - 查看知识库文档

### 6.5 错误日志相关
- `GET /error_logs` - 获取错误日志
- `GET /download_error_log` - 下载错误日志
```